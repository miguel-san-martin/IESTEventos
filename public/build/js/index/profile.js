let eventoleer="";var idu=0;let intro=document.querySelector(".intro-user-profile"),logo=document.querySelector(".logo"),logoSpan=document.querySelectorAll(".logo-parts");async function registraraevento(){const e=new FormData;e.append("iduser",idUser);const t=baseurl+"/eventostaff",o=await fetch(t,{method:"POST",body:e}),n=await o.json();staff(n)}function flipCard(){document.querySelector(".card-mini-profile").classList.toggle("flipped")}window.addEventListener("DOMContentLoaded",()=>{idu=idUser,setTimeout(()=>{logoSpan.forEach((e,t)=>{setTimeout(()=>{e.classList.add("active")},100*(t+1))}),setTimeout(()=>{logoSpan.forEach((e,t)=>{setTimeout(()=>{e.classList.remove("active"),e.classList.add("fade")},50*(e+1))})},580),setTimeout(()=>{intro.style.top="-100vh"},580)})});const $boton=document.querySelector("#btnDownloadIDFront"),$objetivo=document.getElementById("frontID");$boton.addEventListener("click",()=>{html2canvas($objetivo).then(e=>{let t=document.createElement("a");t.download="User-QR.png",t.href=e.toDataURL(),t.click()})});const $botonBack=document.querySelector("#btnDownloadIDBack"),$objetivoBack=document.getElementById("backID");async function getEventosForStaff(){const e=baseurl+"/staff/apigeteventosforstaff",t=await fetch(e),o=await t.json();console.log(o);const n=e=>{const t=new Map;e.forEach(e=>{const o=e.eventop_nombre,n=e.eventop_token,a=e.evento_nombre,s=e.subevento_nombre,i=e.subevento_id,l=e.evento_id,c=e.evento_fecha.split("-"),d=new Date(c[0],c[1]-1,c[2],0,0,0,0),u=new Date;if(r(d,u))if(t.has(o)){const e=t.get(o);e.eventoId=l,i&&e.subeventos.push({nombre:s,id:i,padre:n})}else t.set(o,{nombre:a,subeventos:[],padre:n,eventoId:l}),i&&t.get(o).subeventos.push({nombre:s,id:i,padre:n})});let o="";return t.forEach((e,t)=>{o+=`\n         <div class="eventop_nombre bannernuevo" data-eventop="${t}">\n           ${t} (${e.padre})\n         </div>\n         <div class="evento_nombre ocultar" data-eventop="${t}">\n           <div id="${e.padre}" class="clickeable evento_nombre_div bannernuevo alert" data-evento-id="${e.eventoId}" data-evento-token="${e.padre}">\n             ${e.nombre} (${e.eventoId})\n           </div>\n           ${e.subeventos.map(e=>`<div class="clickeable evento_nombre_div bannernuevo alert" data-evento-id="${e.id}" data-evento-token="${e.padre}">${e.nombre} (${e.id})</div>`).join("")}\n         </div>\n         <hr>\n       `}),o},a=()=>{document.querySelectorAll(".evento_nombre_div").forEach(e=>{e.addEventListener("click",e=>{e.stopPropagation();mostrarEvento(e.currentTarget.getAttribute("data-evento-id"),e.currentTarget.getAttribute("data-evento-token"))})});document.querySelectorAll(".eventop_nombre").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-eventop");document.querySelector(`.evento_nombre[data-eventop="${t}"]`).classList.toggle("ocultar")})})},r=(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate();await(async()=>{const{value:e}=await Swal.fire({title:'Staff <i class="fa-solid fa-window"></i>',html:n(o),footer:'<p class="letra-chica no-margin">Para leer un IestCode, solamente selecciona el evento y el día del evento.</p>',showCancelButton:!1,showConfirmButton:!1,customClass:{popup:"swal"},didOpen:()=>{a()}})})()}let html5QrCodeScanner;async function mostrarEvento(e,t){let o=!1;try{const n=new Audio("build/img/scann.mp3"),a='\n      <div class="row">\n        <div class="col">\n          <div id="reader" style="width: 100%; height: 400px;"></div>\n        </div>\n      </div>\n    ',{value:r,isConfirmed:s}=await Swal.fire({title:'Lectura de Qr <i class="fa-solid fa-scanner-gun"></i>',html:a,footer:'<p class="letra-chica no-margin">Para leer un IestCode, solamente selecciona el evento y el día del evento.</p>',showCancelButton:!1,showConfirmButton:!1,showCloseButton:!0,customClass:{popup:"swal"},didOpen:async()=>{try{html5QrCodeScanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250}),html5QrCodeScanner.render(async a=>{o||(n.play(),o=!0,verificarQr(e,a,t),html5QrCodeScanner.clear(),html5QrCodeScanner.stop())})}catch(e){console.error("Error:",e)}},willClose:()=>{setTimeout(()=>{html5QrCodeScanner&&(html5QrCodeScanner.clear(),html5QrCodeScanner.stop(),delete html5QrCodeScanner)},500)}})}catch(e){console.error("Error:",e)}}async function verificarQr(e,t,o){const n=new FormData;n.append("evento",e),n.append("iestcode",t),n.append("eventoPadre",o);const a=baseurl+"/staff/verifyQr",r=await fetch(a,{method:"POST",body:n}),s=await r.json();if(s.success)validarIdentidad(s.body,e,o);else{new Audio("build/img/qrwrong.mp3").play(),Swal.fire({icon:"error",title:"IestCode no Registrado",text:""+s.message,showConfirmButton:!1,showCancelButton:!0,cancelButtonText:"Entiendo",customClass:{popup:"swalalert"},willClose:()=>{mostrarEvento(e,o)}})}}async function validarIdentidad(e,t,o){var n,a;e.forEach(e=>{n=e.nombre,e.apellidoP,e.apellidoM,e.correo,a=e.id});const{value:r,isConfirmed:s}=await Swal.fire({title:'Valida Identidad <i class="fa-solid fa-address-card"></i>',html:`<br><br>\n      <img class="profile-pic" src="">\n      <br>     \n      <div class="campo">\n        <input value="${n}" disabled>\n      </div>\n      \n      `,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"Registrar",cancelButtonText:"No es",customClass:{popup:"swal"}});s?Swal.fire({title:"Cargando...",icon:"info",html:"Validando datos, por favor espere",allowOutsideClick:!1,footer:'<p class="color-grisBajo no-margin">No cierre la pagina</p>',customClass:{popup:"swalalert"},didOpen:()=>{Swal.showLoading(),registrarAsistencia(t,a,o)}}):mostrarEvento(t,o)}async function registrarAsistencia(e,t,o){const n=new FormData;n.append("iduser",t),n.append("eventoToken",e);const a=baseurl+"/staff/ingresarAsistencia",r=await fetch(a,{method:"POST",body:n}),s=await r.json();if(s.success){new Audio("build/img/qrsuccess.mp3").play(),Swal.fire({icon:"success",title:"Bievenido",text:""+s.message,showConfirmButton:!1,timer:2500,customClass:{popup:"swalalert"},willClose:()=>{mostrarEvento(e,o)}})}else{new Audio("build/img/qryaescaneado.mp3").play(),Swal.fire({icon:"info",title:"Error",text:""+s.message,showConfirmButton:!0,confirmButtonText:"Entiendo",willClose:()=>{mostrarEvento(e,o)},customClass:{popup:"swalalert"}})}}$botonBack.addEventListener("click",()=>{html2canvas($objetivoBack).then(e=>{let t=document.createElement("a");t.download="User-Info.png",t.href=e.toDataURL(),t.click()})});